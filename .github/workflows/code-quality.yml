name: PHP Code Quality

on:
  workflow_call:
    inputs:
      php-version:
        required: false
        default: '8.4'
        type: string

env:
  phpcs_properties_file: .code-quality/phpcs/phpcs.xml
  phpstan_config_file: .code-quality/phpstan/phpstan.neon
  deptrac_config_file: .code-quality/deptrac/deptrac.yaml

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  phpcs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          tools: composer, cs2pr
          coverage: none

      - name: Install dependencies
        run: composer install --no-interaction --no-progress

      - name: Validate PHPCS ruleset exists
        run: |
          if [ ! -f "$phpcs_properties_file" ]; then
            echo "::error file=$phpcs_properties_file::PHPCS ruleset not found"
            exit 1
          fi

      - name: Run PHPCBF
        run: |
          ./vendor/bin/phpcbf --standard=$phpcs_properties_file

      - name: Run PHPCS with PR annotations
        id: phpcs
        continue-on-error: true
        if: github.event.pull_request != null
        run: |
          set +e
          ./vendor/bin/phpcs \
            --standard=$phpcs_properties_file \
            --report=checkstyle \
          | cs2pr
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Fail if PHPCS found errors
        if: steps.phpcs.outputs.exit_code != '0'
        run: exit 1

  phpstan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          tools: composer, cs2pr
          coverage: none

      - name: Install dependencies
        run: composer install --no-interaction --no-progress

      - name: Validate PHPStan config exists
        run: |
          if [ ! -f "$phpstan_config_file" ]; then
            echo "::error file=$phpstan_config_file::PHPStan config not found"
            exit 1
          fi

      - name: Run PHPStan with PR annotations
        id: phpstan
        continue-on-error: true
        if: github.event.pull_request != null
        run: |
          set +e
          ./vendor/bin/phpstan analyse \
            -c $phpstan_config_file \
            --memory-limit=512M \
            --error-format=checkstyle \
          | cs2pr
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Fail if PHPStan found errors
        if: steps.phpstan.outputs.exit_code != '0'
        run: exit 1

  deptrac:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          tools: composer
          coverage: none

      - name: Install dependencies
        run: composer install --no-interaction --no-progress

      - name: Validate Deptrac config exists
        run: |
          if [ ! -f "$deptrac_config_file" ]; then
            echo "::error file=$deptrac_config_file::Deptrac config not found"
            exit 1
          fi

      - name: Run Deptrac with PR annotations
        id: deptrac
        continue-on-error: true
        if: github.event.pull_request != null
        run: |
          set +e
          ./vendor/bin/deptrac analyse \
            --config-file=$deptrac_config_file \
            --fail-on-uncovered \
            --report-uncovered \
            --formatter=github-actions
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Fail if Deptrac found violations
        if: steps.deptrac.outputs.exit_code != '0'
        run: exit 1

  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ inputs.php-version }}
          tools: composer
          coverage: xdebug

      - name: Install dependencies
        run: composer install --no-interaction --no-progress

      - name: Run Unit tests with coverage check (>= 80%)
        run: composer test:unit:coverage:check

      - name: Run Integration tests with coverage check (>= 60%)
        run: composer test:integration:coverage:check

      - name: Run Feature tests
        run: composer test:feature

      - name: Generate test summary
        if: always()
        run: |
          php -r '
          function junit($f) {
              if (!file_exists($f)) return [0, 0, 0];
              $x = simplexml_load_file($f);
              $ts = $x->testsuite ?? $x;
              return [(int)$ts["tests"], (int)$ts["tests"] - (int)$ts["errors"] - (int)$ts["failures"], (int)$ts["errors"] + (int)$ts["failures"]];
          }
          function cov($f) {
              if (!file_exists($f)) return "N/A";
              $x = simplexml_load_file($f)->project->metrics ?? null;
              if (!$x) return "N/A";
              return round(((int)$x["coveredstatements"] / max((int)$x["statements"],1)) * 100, 2) . "%";
          }
          [$ut,$us,$ue] = junit("unit-report.xml");
          [$it,$is,$ie] = junit("integration-report.xml");
          [$ft,$fs,$fe] = junit("feature-report.xml");
          $uc = cov("coverage-unit.xml");
          $ic = cov("coverage-integration.xml");
          echo "## Test Execution Summary\n\n";
          echo "| Category | Total | Success | Errors | Coverage |\n";
          echo "|----------|-------|---------|--------|----------|\n";
          echo "| Unit | $ut | $us | $ue | $uc |\n";
          echo "| Integration | $it | $is | $ie | $ic |\n";
          echo "| Feature | $ft | $fs | $fe | N/A |\n";
          ' >> $GITHUB_STEP_SUMMARY

  notify:
    runs-on: ubuntu-latest
    needs: [phpcs, phpstan, deptrac, tests]
    if: |
      always() &&
      github.event.pull_request != null &&
      (needs.phpcs.result == 'failure' ||
       needs.phpstan.result == 'failure' ||
       needs.deptrac.result == 'failure' ||
       needs.tests.result == 'failure')
    steps:
      - name: Add PR comment if checks failed (deduplicated)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_BODY="Code quality checks failed. Please review the annotations for details."
          EXISTING_COMMENT=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq ".[] | select(.body == \"$COMMENT_BODY\") | .id")
          if [ -z "$EXISTING_COMMENT" ]; then
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
              -f body="$COMMENT_BODY"
          fi
